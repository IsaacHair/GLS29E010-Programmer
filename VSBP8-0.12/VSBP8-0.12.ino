#define ADR 22
#define DATA 40
#define WE 50
#define OE 51
#define CE 52

char buff[200];

#define LEN 1140
long prog[LEN] = {0x0000, 0x00, 0x08, 0x40, 0x08, 0x60, 0x08, -1, 0x0080, 0x00, 0x08, 0x01, 0x0a, 0x40, 0x08, 0x44, 0x08, 0x48, 0x08, 0x4c, 0x08, -1, 0x0100, 0x00, 0x48, 0x60, 0x48, -1, 0x0180, 0x40, 0x48, 0x44, 0x48, 0x48, 0x48, -1, 0x0200, 0x00, 0x28, 0x40, 0x00, 0x60, 0x28, -1, 0x0280, 0x01, 0x00, 0x40, 0x30, 0x44, 0x30, 0x48, 0x30, -1, 0x0380, 0x40, 0x04, 0x44, 0x84, 0x48, 0x02, -1, 0x0400, 0x00, 0x10, 0x40, 0x10, 0x60, 0x10, -1, 0x0480, 0x00, 0x10, 0x01, 0x12, 0x40, 0x10, 0x44, 0x10, 0x48, 0x10, 0x4c, 0x00, -1, 0x0500, 0x00, 0x50, 0x60, 0x50, -1, 0x0580, 0x40, 0x50, 0x44, 0x50, 0x48, 0x50, -1, 0x0600, 0x00, 0x30, 0x40, 0x80, 0x60, 0x30, -1, 0x0680, 0x01, 0x00, 0x40, 0x68, 0x44, 0x68, 0x48, 0x68, -1, 0x0780, 0x40, 0x70, 0x44, 0x70, 0x48, 0x70, -1, 0x0800, 0x00, 0x18, 0x40, 0x20, 0x60, 0x18, -1, 0x0880, 0x00, 0x80, 0x01, 0x22, 0x40, 0x20, 0x44, 0x20, 0x48, 0x20, -1, 0x0900, 0x00, 0x58, 0x60, 0x58, -1, 0x0980, 0x40, 0x58, 0x44, 0x58, 0x48, 0x58, -1, 0x0a00, 0x00, 0x38, 0x60, 0x38, -1, 0x0a80, 0x40, 0x38, 0x44, 0x38, 0x48, 0x38, -1, 0x0b80, 0x40, 0x78, 0x44, 0x78, 0x48, 0x78, -1, 0x0c00, 0x00, 0x20, 0x60, 0x20, -1, 0x0d00, 0x00, 0x00, 0x60, 0x00, -1, 0x0d80, 0x40, 0x60, 0x44, 0x60, 0x48, 0x60, -1, 0x0e00, 0x00, 0x40, 0x60, 0x40, -1, 0x0e80, 0x40, 0x40, 0x44, 0x40, 0x48, 0x40, -1, 0x0f80, 0x40, 0x80, 0x44, 0x80, 0x48, 0x80, -1, 0x1000, 0x00, 0x08, 0x04, 0x08, 0x08, 0x08, 0x0c, 0x08, 0x40, 0x10, 0x44, 0x08, 0x45, 0x0a, 0x46, 0x09, 0x47, 0x0b, 0x50, 0x00, 0x48, 0x08, 0x49, 0x0a, 0x4a, 0x09, 0x4b, 0x0b, 0x60, 0x00, -1, 0x1080, 0x00, 0x08, 0x04, 0x08, 0x08, 0x08, 0x1c, 0x08, 0x20, 0x08, -1, 0x1100, 0x00, 0x48, 0x04, 0x48, 0x08, 0x48, 0x50, 0x00, 0x60, 0x00, -1, 0x1180, 0x00, 0x80, 0x20, 0x48, -1, 0x1200, 0x00, 0x30, 0x04, 0x30, 0x08, 0x30, 0x40, 0x00, 0x44, 0x80, 0x45, 0x81, 0x46, 0x10, 0x47, 0x50, 0x50, 0x00, 0x48, 0x80, 0x49, 0x81, 0x4a, 0x10, 0x4b, 0x50, 0x60, 0x00, -1, 0x1280, 0x00, 0x28, 0x04, 0x00, 0x08, 0x28, 0x1c, 0x00, 0x20, 0x28, -1, 0x1300, 0x00, 0x04, 0x04, 0x84, 0x08, 0x02, 0x50, 0x00, 0x60, 0x00, -1, 0x1400, 0x00, 0x10, 0x04, 0x10, 0x08, 0x10, 0x0c, 0x00, 0x44, 0x10, 0x45, 0x12, 0x46, 0x11, 0x47, 0x13, 0x50, 0x00, 0x48, 0x10, 0x49, 0x12, 0x4a, 0x11, 0x4b, 0x13, 0x60, 0x00, -1, 0x1480, 0x00, 0x10, 0x04, 0x10, 0x08, 0x10, 0x1c, 0x10, 0x20, 0x10, -1, 0x1500, 0x00, 0x50, 0x04, 0x50, 0x08, 0x50, 0x50, 0x00, 0x60, 0x00, -1, 0x1580, 0x20, 0x50, -1, 0x1600, 0x00, 0x68, 0x04, 0x68, 0x08, 0x68, 0x40, 0x30, 0x44, 0x04, 0x45, 0x05, 0x46, 0x18, 0x47, 0x58, 0x50, 0x00, 0x48, 0x04, 0x49, 0x05, 0x4a, 0x18, 0x4b, 0x58, 0x60, 0x00, -1, -2};
void setup() {
  Serial.begin(115200);
  while(!Serial)
    delay(10);
  int i;
  int len;
  for (i = 22; i <= 53; i++)
    pinMode(i, INPUT);

  pinMode(WE, OUTPUT);
  digitalWrite(WE, HIGH);
  pinMode(OE, OUTPUT);
  digitalWrite(OE, HIGH);
  pinMode(CE, OUTPUT);
  digitalWrite(CE, LOW);
  for (i = 0; i < 17; i++)
    pinMode(ADR+i, OUTPUT);
  for (i = 0; i < 8; i++)
    pinMode(DATA+i, OUTPUT);
  page();

  for (i = 0; i < 8; i++)
    pinMode(DATA+i, INPUT);
  showall();
}

void page()
{
  long i, j;
  int pagehere;
  long pagen;
  for (i = 0, pagehere = 1; i < LEN;) {
    if (prog[i] == -2)
      break;
    else if (pagehere) {
      def(0x5555, 0xAA);
      def(0x2AAA, 0x55);
      def(0x5555, 0xA0);
      pagen = prog[i];
      pagehere = 0;
      i++;
    }
    else if (prog[i] == -1) {
      pagehere = 1;
      digitalWrite(WE, HIGH);
      delay(20);
      i++;
    }
    else {
      def(pagen+prog[i], prog[i+1]);
      i += 2;
    }
  }
}

void setadr(long a)
{
  long i;
  for (i = 0; i < 17; i++)
    digitalWrite(ADR+i, LOW);
  for (i = 0; i < 17; i++)
    if (a & (1 << i))
      digitalWrite(ADR+i, HIGH);
}

void setval(int v)
{
  long i;
  for (i = 0; i < 8; i++)
    digitalWrite(DATA+i, LOW);
  for (i = 0; i < 8; i++)
    if (v & (1 << i))
      digitalWrite(DATA+i, HIGH);
}

void def(long a, int v)
{
  long i;
  setadr(a);
  digitalWrite(WE, HIGH);
  delayMicroseconds(5);
  digitalWrite(WE, LOW);
  setval(v);
}

int show(long a)
{
  long i;
  int val;
  digitalWrite(OE, LOW);
  setadr(a);
  delayMicroseconds(5);
  for (val = 0, i = 0; i < 8; i++)
    if (digitalRead(DATA+i))
      val += (1 << i);
  digitalWrite(OE, HIGH);
  return (val);
}

long showall()
{
  long i, j;
  long pagen;
  int pagehere;
  long pageindex;
  long err;
  for (i = 0, err = 0, pagehere = 1; i < LEN;) {
    if (prog[i] == -2)
      break;
    if (pagehere) {
      pagen = prog[i];
      pageindex = i;
      pagehere = 0;
      i++;
    }
    else if (prog[i] == -1) {
      pagehere = 1;
      i++;
    }
    else {
      if (!(show(pagen+prog[i]) == prog[i+1])) {
        Serial.println(show(pagen+prog[i]));
        err++;
      }
      i += 2;
    }
  }
  Serial.print("errors:");
  Serial.println(err);
  Serial.flush();
  return (err);
}

void loop() {}
